<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight Graph | KinderCare</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYkRSxHjVrV9QYk45EDP5K2uHOoW-0pkk",
            authDomain: "kindercare-cd7da.firebaseapp.com",
            projectId: "kindercare-cd7da",
            storageBucket: "kindercare-cd7da.firebasestorage.app",
            messagingSenderId: "930908122510",
            appId: "1:930908122510:web:40f89ca7a5cf8dc3fb48df"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let weightChartInstance = null; // Store the chart instance

        // Load children into dropdown
        async function loadChildren() {
            const childrenDropdown = document.getElementById("childSelect");
            const childrenSnapshot = await getDocs(collection(db, "children"));
            childrenSnapshot.forEach((docSnap) => {
                const childData = docSnap.data();
                const option = document.createElement("option");
                option.value = docSnap.id;
                option.textContent = childData.ChildName;
                childrenDropdown.appendChild(option);
            });
        }

        // Display the weight graph when a child is selected
        async function displayWeightGraph() {
            const childId = document.getElementById("childSelect").value;

            if (!childId) {
                return; // Do nothing if no child is selected
            }

            const growthQuery = query(collection(db, "growth"), where("childId", "==", childId));
            const growthSnapshot = await getDocs(growthQuery);

            const growthData = [];

            growthSnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                growthData.push({ age: data.age, weight: data.weight });
            });

            if (growthData.length > 0) {
                growthData.sort((a, b) => a.age - b.age);

                const filteredGrowthData = growthData.filter(item => item.age !== undefined && item.weight !== undefined);

                const sortedAges = filteredGrowthData.map(item => item.age);
                const sortedWeights = filteredGrowthData.map(item => item.weight);

                // Destroy previous chart instance if it exists
                if (weightChartInstance) {
                    weightChartInstance.destroy();
                }

                createWeightChart(sortedAges, sortedWeights); // Create the new chart
            } else {
                alert("No growth records found for the selected child.");
            }
        }

        // Create the weight chart
        function createWeightChart(xData, yData) {
            const ctx = document.getElementById("weightChart").getContext('2d');
            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xData,
                    datasets: [{
                        label: 'Weight (kg)',
                        data: yData,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age (Months)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Weight (kg)'
                            },
                            ticks: {
                                stepSize: 1, // Adjusting weight axis increment to 1kg
                            }
                        }
                    }
                }
            });
        }

        // Event listener for dropdown change to automatically update the graph
        document.addEventListener("DOMContentLoaded", () => {
            loadChildren();
            document.getElementById("childSelect").addEventListener("change", displayWeightGraph);
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>Weight Graph</h1>
        <label for="childSelect">Weight graph for:</label>
        <select id="childSelect" required>
            <option value="">-- Select Child --</option>
        </select>

        <div>
            <canvas id="weightChart" width="500" height="300"></canvas>
        </div>
        <br><br>
        <button class="button button-primary" onclick="window.location.href='growth-graph.html'">← Back to Growth Dashboard</button>
        <button class="button button-secondary" onclick="window.location.href='dashboard.html'">← Back to Dashboard</button>
    </div>
</body>
</html>
