<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Milestone | KinderCare</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Edit Milestone</h1>
        <form id="editMilestoneForm">
            <label>Child Name:</label>
            <input type="text" id="childName" disabled>

            <label for="date">Date Achieved:</label>
            <input type="date" id="date" required>

            <label for="milestoneType">Milestone Type:</label>
            <input type="text" id="milestoneType" required>

            <label for="remark">Remark:</label>
            <input type="text" id="remark">

            <button type="submit" class="button">Update Milestone</button>
            <button type="button" class="button button-secondary" onclick="window.location.href='milestone.html'">‚Üê Back</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYkRSxHjVrV9QYk45EDP5K2uHOoW-0pkk",
            authDomain: "kindercare-cd7da.firebaseapp.com",
            projectId: "kindercare-cd7da",
            storageBucket: "kindercare-cd7da.firebasestorage.app",
            messagingSenderId: "930908122510",
            appId: "1:930908122510:web:40f89ca7a5cf8dc3fb48df"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get the milestone ID from the URL query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const milestoneId = urlParams.get("milestoneId");

        async function loadMilestone() {
            if (!milestoneId) {
                alert("Milestone ID is missing from the URL.");
                return;
            }

            const milestoneRef = doc(db, "milestones", milestoneId); // Corrected collection name
            const milestoneSnap = await getDoc(milestoneRef);

            if (milestoneSnap.exists()) {
                const data = milestoneSnap.data();
                document.getElementById("date").value = data.dateAchieved; // Pre-fill date
                document.getElementById("milestoneType").value = data.milestoneType; // Pre-fill milestone type
                document.getElementById("remark").value = data.remark || ""; // Pre-fill remark

                // Fetch child name based on the childId in the milestone
                const childRef = doc(db, "children", data.childId);
                const childSnap = await getDoc(childRef);
                if (childSnap.exists()) {
                    document.getElementById("childName").value = childSnap.data().ChildName; // Pre-fill child name
                }
            } else {
                alert("Milestone not found!");
            }
        }

        // Event listener for form submission
        document.getElementById("editMilestoneForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const date = document.getElementById("date").value;
            const milestoneType = document.getElementById("milestoneType").value;
            const remark = document.getElementById("remark").value;

            const milestoneRef = doc(db, "milestones", milestoneId);
            await updateDoc(milestoneRef, {
                dateAchieved: date,
                milestoneType: milestoneType,
                remark: remark
            });

            alert("Milestone updated successfully.");
            window.location.href = "milestone.html"; // Redirect back to the milestone list
        });

        // Load milestone data when the page is loaded
        document.addEventListener("DOMContentLoaded", loadMilestone);
    </script>
</body>
</html>
